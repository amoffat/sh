

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Tutorial 2: Entering an SSH password &mdash; sh 1.12.0 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="sh 1.12.0 documentation" href="../index.html"/>
        <link rel="prev" title="Tutorial 1: Tailing a real-time log file" href="1-real_time_output.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> sh
          

          
          </a>

          
            
            
              <div class="version">
                1.12.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="1-real_time_output.html">Tutorial 1: Tailing a real-time log file</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Tutorial 2: Entering an SSH password</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#how-you-should-really-be-using-ssh">How you should REALLY be using SSH</a></li>
<li class="toctree-l2"><a class="reference internal" href="#would-you-like-to-know-more">Would you like to know more?</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">sh</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
    <li>Tutorial 2: Entering an SSH password</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/tutorials/2-interacting_with_processes.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="tutorial-2-entering-an-ssh-password">
<span id="tutorial2"></span><h1>Tutorial 2: Entering an SSH password<a class="headerlink" href="#tutorial-2-entering-an-ssh-password" title="Permalink to this headline">¶</a></h1>
<p>Using <a class="reference external" href="http://docs.python.org/library/subprocess.html">subprocesses</a> to
interact with
SSH is notoriously difficult.  It is recommended that you just <code class="docutils literal"><span class="pre">ssh-copy-id</span></code>
to copy your public key to the server so you don&#8217;t need to enter your password,
but for the purposes of this demonstration, we try to enter a password.</p>
<p>To interact with a process, we need to assign a callback to STDOUT.  See
<a class="reference internal" href="1-real_time_output.html#tutorial1"><span class="std std-ref">Tutorial 1: Tailing a real-time log file</span></a> for in-depth explanation of callbacks.  Unlike Tutorial 1,
this callback
will take 2 arguments: the STDOUT chunk
and a STDIN <a class="reference external" href="http://docs.python.org/library/queue.html#queue-objects">Queue</a>
object that we will <code class="docutils literal"><span class="pre">.put()</span></code> input on to send back to the process.</p>
<p>Here&#8217;s our first attempt:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sh</span> <span class="k">import</span> <span class="n">ssh</span>

<span class="k">def</span> <span class="nf">ssh_interact</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">stdin</span><span class="p">):</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;password:&quot;</span><span class="p">):</span>
        <span class="n">stdin</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">&quot;correcthorsebatterystaple&quot;</span><span class="p">)</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">ssh</span><span class="p">(</span><span class="s2">&quot;10.10.10.100&quot;</span><span class="p">,</span> <span class="n">_out</span><span class="o">=</span><span class="n">ssh_interact</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
</pre></div>
</div>
<p>If you run this (substituting an IP that you can SSH to), you&#8217;ll notice that
nothing is printed.  The problem has to do with STDOUT buffering.  By default,
sh line-buffers STDOUT, which means that <code class="docutils literal"><span class="pre">ssh_interact</span></code> will only receive output when
sh encounters a newline in the output.  This is a problem because the password
prompt has no newline:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">amoffat</span><span class="nd">@10</span><span class="o">.</span><span class="mf">10.10</span><span class="o">.</span><span class="mi">100</span><span class="s1">&#39;s password:</span>
</pre></div>
</div>
<p>Because a newline is never encountered, nothing is sent to <code class="docutils literal"><span class="pre">ssh_interact</span></code>.
So we need to change
the STDOUT buffering.  We do this with the <code class="docutils literal"><span class="pre">_out_bufsize</span></code>
<a class="reference internal" href="../special_arguments.html#special-arguments"><span class="std std-ref">special keyword argument</span></a>.  We&#8217;ll set it to 0 for
unbuffered output, so we&#8217;ll receive each character as the process writes it
(also see <a class="reference internal" href="../index.html#buffer-sizes"><span class="std std-ref">Buffer sizes</span></a>):</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sh</span> <span class="k">import</span> <span class="n">ssh</span>

<span class="k">def</span> <span class="nf">ssh_interact</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">stdin</span><span class="p">):</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;password:&quot;</span><span class="p">):</span>
        <span class="n">stdin</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">&quot;correcthorsebatterystaple&quot;</span><span class="p">)</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">ssh</span><span class="p">(</span><span class="s2">&quot;10.10.10.100&quot;</span><span class="p">,</span> <span class="n">_out</span><span class="o">=</span><span class="n">ssh_interact</span><span class="p">,</span> <span class="n">_out_bufsize</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
</pre></div>
</div>
<p>If you run this updated version, you&#8217;ll notice a new problem.  The output looks
like this:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="s1">&#39;a&#39;</span>
<span class="s1">&#39;m&#39;</span>
<span class="s1">&#39;o&#39;</span>
<span class="s1">&#39;f&#39;</span>
<span class="s1">&#39;f&#39;</span>
<span class="s1">&#39;a&#39;</span>
<span class="s1">&#39;t&#39;</span>
<span class="s1">&#39;@&#39;</span>
<span class="s1">&#39;1&#39;</span>
<span class="s1">&#39;0&#39;</span>
<span class="s1">&#39;.&#39;</span>
<span class="s1">&#39;1&#39;</span>
<span class="s1">&#39;0&#39;</span>
<span class="s1">&#39;.&#39;</span>
<span class="s1">&#39;1&#39;</span>
<span class="s1">&#39;0&#39;</span>
<span class="s1">&#39;.&#39;</span>
<span class="s1">&#39;1&#39;</span>
<span class="s1">&#39;0&#39;</span>
<span class="s1">&#39;0&#39;</span>
<span class="s2">&quot;&#39;&quot;</span>
<span class="s1">&#39;s&#39;</span>
<span class="s1">&#39; &#39;</span>
<span class="s1">&#39;p&#39;</span>
<span class="s1">&#39;a&#39;</span>
<span class="s1">&#39;s&#39;</span>
<span class="s1">&#39;s&#39;</span>
<span class="s1">&#39;w&#39;</span>
<span class="s1">&#39;o&#39;</span>
<span class="s1">&#39;r&#39;</span>
<span class="s1">&#39;d&#39;</span>
<span class="s1">&#39;:&#39;</span>
<span class="s1">&#39; &#39;</span>
</pre></div>
</div>
<p>This is because the chunks of STDOUT our callback is receiving are unbuffered,
and are therefore individual characters, instead of entire lines.  What we need
to do now is aggregate this character-by-character data into something more
meaningful for us to test if the pattern <code class="docutils literal"><span class="pre">password:</span></code> has been sent, signifying
that SSH is ready for input.
It would make sense to encapsulate the
variable we&#8217;ll use for aggregating into some kind of closure or class, but to keep it simple,
we&#8217;ll just use a global:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sh</span> <span class="k">import</span> <span class="n">ssh</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span>

<span class="c1"># open stdout in unbuffered mode</span>
<span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fdopen</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="s2">&quot;wb&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="n">aggregated</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<span class="k">def</span> <span class="nf">ssh_interact</span><span class="p">(</span><span class="n">char</span><span class="p">,</span> <span class="n">stdin</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">aggregated</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">char</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
    <span class="n">aggregated</span> <span class="o">+=</span> <span class="n">char</span>
    <span class="k">if</span> <span class="n">aggregated</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;password: &quot;</span><span class="p">):</span>
        <span class="n">stdin</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">&quot;correcthorsebatterystaple&quot;</span><span class="p">)</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">ssh</span><span class="p">(</span><span class="s2">&quot;10.10.10.100&quot;</span><span class="p">,</span> <span class="n">_out</span><span class="o">=</span><span class="n">ssh_interact</span><span class="p">,</span> <span class="n">_out_bufsize</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
</pre></div>
</div>
<p>Also notice that we open <code class="docutils literal"><span class="pre">sys.stdout</span></code> in unbuffered mode by re-opening it
with <code class="docutils literal"><span class="pre">os.fdopen</span></code>.
This allows us to use <code class="docutils literal"><span class="pre">sys.stdout.write</span></code> to print each character as we
receive it, without adding a newline, and without us needing to <code class="docutils literal"><span class="pre">.flush()</span></code> it.</p>
<p>You&#8217;ll also notice that the example still doesn&#8217;t work.  There are two problems:
The first is that your password must end with a newline, as if you had typed
it and hit the return key.  This is because SSH has no idea how long your
password is, and is line-buffering STDIN.  The second problem lies
deeper in SSH.  Long story short, SSH needs a <a class="reference internal" href="../index.html#ttys"><span class="std std-ref">TTY</span></a> attached
to its STDIN in order to work properly.  This &#8220;tricks&#8221; SSH into believing that
it is interacting with a real user in a real terminal session.
To enable TTY, we can add the <code class="docutils literal"><span class="pre">_tty_in</span></code> <a class="reference internal" href="../special_arguments.html#special-arguments"><span class="std std-ref">special keyword argument</span></a>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sh</span> <span class="k">import</span> <span class="n">ssh</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span>

<span class="c1"># open stdout in unbuffered mode</span>
<span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fdopen</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="s2">&quot;wb&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="n">aggregated</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<span class="k">def</span> <span class="nf">ssh_interact</span><span class="p">(</span><span class="n">char</span><span class="p">,</span> <span class="n">stdin</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">aggregated</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">char</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
    <span class="n">aggregated</span> <span class="o">+=</span> <span class="n">char</span>
    <span class="k">if</span> <span class="n">aggregated</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;password: &quot;</span><span class="p">):</span>
        <span class="n">stdin</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">&quot;correcthorsebatterystaple</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">ssh</span><span class="p">(</span><span class="s2">&quot;10.10.10.100&quot;</span><span class="p">,</span> <span class="n">_out</span><span class="o">=</span><span class="n">ssh_interact</span><span class="p">,</span> <span class="n">_out_bufsize</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">_tty_in</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
</pre></div>
</div>
<p>Voilà our remote login script works!:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>amoffat@10.10.10.100&#39;s password:
Linux 10.10.10.100 testhost #1 SMP Tue Jun 21 10:29:24 EDT 2011 i686 GNU/Linux
Ubuntu 10.04.2 LTS

Welcome to Ubuntu!
 * Documentation:  https://help.ubuntu.com/

66 packages can be updated.
53 updates are security updates.

Ubuntu 10.04.2 LTS

Welcome to Ubuntu!
 * Documentation:  https://help.ubuntu.com/
You have new mail.
Last login: Thu Sep 13 03:53:00 2012 from some.ip.address
amoffat@10.10.10.100:~$
</pre></div>
</div>
<div class="section" id="how-you-should-really-be-using-ssh">
<h2>How you should REALLY be using SSH<a class="headerlink" href="#how-you-should-really-be-using-ssh" title="Permalink to this headline">¶</a></h2>
<p>Many people want to learn how to enter an SSH password by script because they
want to execute remote commands on a server.  Instead of trying to log in
through SSH and then sending terminal input of the command to run, let&#8217;s see
how we can do it another way.</p>
<p>First, open a terminal and run <code class="docutils literal"><span class="pre">ssh-copy-id</span> <span class="pre">yourservername</span></code>.  You&#8217;ll be asked
to enter your password for the server.  After entering your password, you&#8217;ll
be able to SSH into the server without needing a password again.  This
simplifies things greatly for sh.</p>
<p>The second thing we want to do is use SSH&#8217;s ability to pass a command to run
to the server you&#8217;re SSHing to.  Here&#8217;s how you can run <code class="docutils literal"><span class="pre">ifconfig</span></code> on a server
without having to use that server&#8217;s shell:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">ssh</span> <span class="n">amoffat</span><span class="nd">@10</span><span class="o">.</span><span class="mf">10.10</span><span class="o">.</span><span class="mi">100</span> <span class="n">ifconfig</span>
</pre></div>
</div>
<p>Translating this to sh, it becomes:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sh</span>

<span class="nb">print</span><span class="p">(</span><span class="n">sh</span><span class="o">.</span><span class="n">ssh</span><span class="p">(</span><span class="s2">&quot;amoffat@10.10.10.100&quot;</span><span class="p">,</span> <span class="s2">&quot;ifconfig&quot;</span><span class="p">))</span>
</pre></div>
</div>
<p>However there is more room for improvement.  We can take advantage of sh&#8217;s
<a class="reference internal" href="../index.html#baking"><span class="std std-ref">Baking</span></a> to bind our server username/ip to a command object:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sh</span>

<span class="n">my_server</span> <span class="o">=</span> <span class="n">sh</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">bake</span><span class="p">(</span><span class="s2">&quot;amoffat@10.10.10.100&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">my_server</span><span class="p">(</span><span class="s2">&quot;ifconfig&quot;</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">my_server</span><span class="p">(</span><span class="s2">&quot;whoami&quot;</span><span class="p">))</span>
</pre></div>
</div>
<p>Now we have a reusable command object that we can use to call remote commands.
But there is room for one more improvement.  We can also use sh&#8217;s
<a class="reference internal" href="../index.html#subcommands"><span class="std std-ref">Sub-commands</span></a> feature which expands attribute access into command
arguments:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sh</span>

<span class="n">my_server</span> <span class="o">=</span> <span class="n">sh</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">bake</span><span class="p">(</span><span class="s2">&quot;amoffat@10.10.10.100&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">my_server</span><span class="o">.</span><span class="n">ifconfig</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">my_server</span><span class="o">.</span><span class="n">whoami</span><span class="p">())</span>
</pre></div>
</div>
<p>The above example is the same as passing in the arguments explicitly, but it
looks syntactically cleaner.</p>
</div>
<div class="section" id="would-you-like-to-know-more">
<h2>Would you like to know more?<a class="headerlink" href="#would-you-like-to-know-more" title="Permalink to this headline">¶</a></h2>
<p>sh (previously <a class="reference external" href="http://pypi.python.org/pypi/pbs">pbs</a>) is a full-fledged
subprocess interface for Python that
allows you to call any program as if it were a function:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sh</span> <span class="k">import</span> <span class="n">ifconfig</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ifconfig</span><span class="p">(</span><span class="s2">&quot;wlan0&quot;</span><span class="p">))</span>
</pre></div>
</div>
<ul class="simple">
<li>Full docs: <a class="reference external" href="http://amoffat.github.com/sh">http://amoffat.github.com/sh</a></li>
<li>Follow on Github: <a class="reference external" href="http://github.com/amoffat/sh">http://github.com/amoffat/sh</a></li>
</ul>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href="1-real_time_output.html" class="btn btn-neutral" title="Tutorial 1: Tailing a real-time log file" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2013, Andrew Moffat.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'1.12.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>